# 数据库迁移命令指南（Alembic 使用手册） 
#测1111
本项目使用 Alembic 管理数据库结构变更，替代了原来的"自动建表"方式。

## 📋 目录
- [场景一：从 Git 拉取项目，首次运行](#场景一从-git-拉取项目首次运行)
- [场景二：修改了表结构，需要更新数据库](#场景二修改了表结构需要更新数据库)
- [场景三：回滚数据库到之前版本](#场景三回滚数据库到之前版本)
- [场景四：查看数据库版本历史](#场景四查看数据库版本历史)
- [常见问题与注意事项](#常见问题与注意事项)

---

## 场景一：从 Git 拉取项目，首次运行

**目标**：像以前一样，拉完代码后能直接跑起来

### 步骤 1：安装依赖
```powershell
cd "D:\Users\Cold\Desktop\PRO\changchun polytechnic\modeltrain\backend"
pip install -r requirements.txt
```

### 步骤 2：执行数据库迁移（一键搞定）
```powershell
alembic upgrade head
```

**完成！** 现在可以启动后端了。

---

## 场景二：修改了表结构，需要更新数据库

**目标**：像以前一样，改完 ORM 模型，数据库结构也跟着更新

### 案例 A：新增字段
**场景**：在 `User` 表中新增 `is_active` 字段

1. **修改模型文件**（`app/models/user.py`）
```python
class User(Base):
    # ... 原有字段 ...
    is_active = Column(Boolean, default=True)  # 新增字段
```

2. **生成迁移脚本**
```powershell
alembic revision --autogenerate -m "新增 is_active 字段到 users 表"
```

3. **检查生成的脚本**（可选，但推荐）
- 打开 `alembic/versions/` 目录下刚生成的文件
- 确认变更正确（通常自动生成都是对的）

4. **执行迁移**
```powershell
alembic upgrade head
```

### 案例 B：新增表
**场景**：新增 `UserProfile` 表

1. **创建新模型文件**（`app/models/user_profile.py`）
```python
class UserProfile(Base):
    __tablename__ = "user_profiles"
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey("users.id"))
    bio = Column(Text)
```

2. **生成迁移脚本**
```powershell
alembic revision --autogenerate -m "新增 user_profiles 表"
```

3. **执行迁移**
```powershell
alembic upgrade head
```

### 案例 C：重命名字段（需要手动调整）
**场景**：将 `User` 表的 `username` 重命名为 `user_name`

1. **修改模型文件**
```python
class User(Base):
    # username = Column(String(50))  # 删除这行
    user_name = Column(String(50))   # 新增这行
```

2. **生成迁移脚本**
```powershell
alembic revision --autogenerate -m "重命名 username 为 user_name"
```

3. **手动编辑迁移脚本**（重要！）
- 打开生成的迁移文件
- 将自动生成的"删除+新增"改为"重命名"：
```python
# 自动生成的（错误）：
# op.drop_column('users', 'username')
# op.add_column('users', sa.Column('user_name', sa.String(50)))

# 手动修改为（正确）：
op.alter_column('users', 'username', new_column_name='user_name')
```

4. **执行迁移**
```powershell
alembic upgrade head
```

---

## 场景三：回滚数据库到之前版本

### 回滚到上一个版本
```powershell
alembic downgrade -1
```

### 回滚到指定版本
```powershell
# 先查看版本历史
alembic history --verbose

# 回滚到指定版本（替换 abc123 为实际版本号）
alembic downgrade abc123
```

### 案例：回滚新增字段
**场景**：刚才新增的 `is_active` 字段有问题，需要回滚

```powershell
# 回滚到上一个版本
alembic downgrade -1

# 或者回滚到指定版本
alembic downgrade <上一个版本的ID>
```

---

## 场景四：查看数据库版本历史

### 查看当前版本
```powershell
alembic current
```

### 查看版本历史
```powershell
alembic history --verbose
```

### 案例：检查迁移状态
```powershell
# 查看当前版本
PS> alembic current
INFO  [alembic.runtime.migration] Context impl SQLiteImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
abc123 (head)

# 查看历史
PS> alembic history --verbose
abc123 -> def456 (head), 新增 is_active 字段到 users 表
def456 -> ghi789 (head), 新增 user_profiles 表
```

---

## 常见问题与注意事项

### ❓ 什么时候需要手动编辑迁移脚本？
- **重命名字段/表**：自动生成会变成"删除+新增"，需要手动改为"重命名"
- **复杂索引调整**：可能需要手动调整索引创建/删除逻辑
- **数据迁移**：需要在脚本中添加数据转换逻辑

### ❓ 迁移脚本生成失败怎么办？
```powershell
# 如果提示找不到模型，确保所有模型都已导入
# 在 alembic/env.py 中确保导入了所有模型文件
```

### ❓ SQLite 特殊注意事项
- SQLite 不支持某些 DDL 操作（如删除列）
- Alembic 会自动生成"临时表+数据搬迁"的逻辑
- 务必检查生成的脚本，确保数据不会丢失

### ❓ 生产环境部署
```powershell
# 部署前执行
alembic upgrade head
```

### ❓ 团队协作
- 迁移脚本要提交到 Git
- 拉取代码后先执行 `alembic upgrade head`
- 不要手动修改数据库结构，统一用迁移脚本

---

## 🚀 快速参考

### 最常用的三个命令
```powershell
# 1. 生成迁移（修改模型后）
alembic revision --autogenerate -m "你的改动说明"

# 2. 执行迁移
alembic upgrade head

# 3. 查看当前版本
alembic current
```

### 迁移说明命名建议
- 新增字段：`新增 xxx 字段到 yyy 表`
- 新增表：`新增 xxx 表`
- 重命名：`重命名 xxx 为 yyy`
- 修复：`修复 xxx 问题`
- 初始化：`init schema`


