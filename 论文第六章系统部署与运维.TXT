六、系统部署与运维

系统开发完成后需要部署到生产环境，本章介绍系统的部署架构、部署步骤和运维方案，为系统的生产运行提供技术支持。部署过程需要考虑系统的可用性、安全性、可维护性等因素，确保系统能够稳定运行并便于后期维护。

（一）部署架构设计

系统采用前后端分离架构，支持灵活的部署方式。前端使用Vue 3构建单页应用，编译为静态文件，通过Nginx提供HTTP服务。后端使用FastAPI构建RESTful API，通过Uvicorn ASGI服务器运行。数据库使用SQLite存储业务数据，支持迁移到PostgreSQL[10]等生产级数据库。LLM推理服务支持Ollama本地部署或OpenAI API远程调用。

1. 系统架构层次

部署架构分为五个层次：

（1）用户层：用户通过浏览器访问系统，支持Chrome、Firefox、Edge、Safari等主流浏览器。

（2）接入层：使用Nginx作为反向代理服务器，处理静态资源请求和API请求转发，提供负载均衡和SSL终端功能。

（3）应用层：包括前端Vue应用和后端FastAPI服务。前端负责用户界面展示和交互，后端负责业务逻辑处理和数据管理。

（4）数据层：使用SQLite数据库存储用户信息、模型配置、对话记录等业务数据。支持数据备份和恢复功能。

（5）推理层：集成大语言模型推理服务，支持Ollama本地模型部署和OpenAI等云端API调用。

2. 部署模式

系统支持三种部署模式，可根据实际需求选择：

表6-1 部署模式对比
部署模式        适用场景            优势                        劣势
单机部署        中小型企业          部署简单、成本低            扩展性有限
分布式部署      大型企业            高可用、可水平扩展          部署复杂、成本高
容器化部署      DevOps团队          快速部署、版本管理方便      需要容器化经验

单机部署将所有服务部署在一台服务器上，适合用户量较小的场景。分布式部署将前端、后端、数据库分别部署在不同服务器上，可根据负载情况独立扩展。容器化部署使用Docker容器化各个服务，便于快速部署和版本管理。

（二）后端部署

后端部署包括Python环境配置、依赖包安装、数据库初始化、服务配置和启动等步骤。

1. Python环境配置

后端服务基于Python开发，需要配置Python运行环境。推荐使用Python 3.10及以上版本，使用虚拟环境隔离项目依赖。

表6-2 后端环境要求
环境项目            要求说明
操作系统            Ubuntu LTS / CentOS / Windows Server
Python版本          3.10及以上
内存                4GB及以上（推荐8GB）
磁盘空间            20GB及以上
网络                可访问外网（用于API调用）

环境配置步骤：首先安装Python解释器和pip包管理工具，然后创建项目专用的虚拟环境，激活虚拟环境后安装项目依赖包。使用虚拟环境可以避免与系统Python环境产生冲突，便于项目的独立管理和部署。

2. 依赖包安装

项目依赖包通过requirements.txt文件管理，包含FastAPI、Uvicorn、SQLAlchemy、Alembic等核心组件。

表6-3 主要依赖包说明
依赖包名称          功能说明
FastAPI            高性能Web框架，提供RESTful API支持
Uvicorn            ASGI服务器，运行FastAPI应用
SQLAlchemy         ORM框架，提供数据库操作抽象
Alembic            数据库迁移工具，管理数据库结构变更
python-jose        JWT令牌生成和验证
passlib            密码哈希和验证
httpx              异步HTTP客户端，调用外部API
pydantic           数据验证和序列化

安装依赖包时建议使用国内镜像源加速下载，安装完成后验证各核心包是否正确安装。

3. 数据库初始化

系统使用SQLAlchemy ORM框架和Alembic迁移工具管理数据库。首次部署时需要初始化数据库结构和基础数据。

数据库初始化步骤：

（1）配置数据库连接：在.env配置文件中设置数据库连接字符串，SQLite使用文件路径，PostgreSQL使用连接URL。

（2）执行数据库迁移：运行Alembic迁移命令创建数据库表结构，包括用户表、模型配置表、对话会话表、消息表等。

（3）初始化基础数据：系统自动创建默认管理员账号和初始配置数据。默认管理员邮箱为admin@example.com，密码为admin123，建议首次登录后立即修改密码。

4. 配置文件设置

系统通过.env配置文件管理运行时配置，包括数据库连接、安全密钥、跨域设置等。

表6-4 主要配置项说明
配置项              说明                            示例值
DATABASE_URL        数据库连接字符串                sqlite:///./modeltrain.db
SECRET_KEY          JWT签名密钥                     随机生成的强密钥
CORS_ORIGINS        允许的跨域来源                  http://localhost:5173
ACCESS_TOKEN_EXPIRE 访问令牌过期时间（分钟）        30
REFRESH_TOKEN_EXPIRE刷新令牌过期时间（天）          7

配置文件中的SECRET_KEY必须使用随机生成的强密钥，避免使用简单字符串。生产环境部署时应修改默认配置，确保系统安全。

5. 服务启动与管理

生产环境推荐使用Gunicorn配合Uvicorn Worker运行FastAPI应用，支持多进程并发处理请求。使用Systemd管理服务进程，实现开机自启动和进程监控。

服务配置要点：

（1）Worker进程数：根据服务器CPU核心数配置，一般设置为CPU核心数的2倍加1。

（2）监听地址：生产环境监听本地地址127.0.0.1，由Nginx反向代理对外提供服务。

（3）日志配置：配置日志输出路径和级别，生产环境使用INFO级别，调试时可使用DEBUG级别。

（4）进程管理：创建Systemd服务单元文件，配置服务启动命令、工作目录、环境变量等，设置开机自启动和异常重启策略。

（三）前端部署

前端部署包括Node.js环境配置、项目构建和Nginx配置等步骤。

1. 项目构建

前端项目使用Vue 3框架和Vite构建工具开发，部署前需要构建生产版本。

构建步骤：

（1）安装Node.js环境：安装Node.js LTS版本和npm包管理工具。

（2）安装项目依赖：进入前端项目目录，运行npm install安装依赖包。

（3）配置环境变量：修改.env.production文件，配置生产环境API地址。

（4）执行构建命令：运行npm run build命令，生成生产版本静态文件。

构建完成后，静态文件输出到dist目录，包含HTML、CSS、JavaScript和资源文件。构建过程会进行代码压缩、Tree-shaking、资源优化等处理，减小文件体积，提高加载速度。

表6-5 构建产物说明
文件类型            说明                            优化措施
HTML文件            应用入口页面                    压缩、内联关键CSS
JavaScript文件      应用逻辑代码                    压缩、混淆、代码分割
CSS文件             样式文件                        压缩、移除无用样式
静态资源            图片、字体等                    压缩、指纹命名

2. Nginx配置

使用Nginx作为Web服务器，提供静态文件服务和API反向代理功能。

Nginx配置要点：

（1）静态文件服务：配置前端构建产物目录为网站根目录，设置默认首页为index.html。

（2）SPA路由支持：配置try_files指令，将所有路由请求重定向到index.html，支持前端路由。

（3）API反向代理：配置/api路径代理到后端服务，传递客户端真实IP和请求头信息。

（4）SSE流式响应支持：关闭代理缓冲和缓存，配置较长的读取超时时间，确保流式响应正常传输。

（5）性能优化：启用Gzip压缩，配置静态资源缓存策略，减少带宽占用和加载时间。

3. HTTPS配置

生产环境必须配置HTTPS，保护数据传输安全。推荐使用Let's Encrypt免费SSL证书。

HTTPS配置步骤：

（1）安装Certbot工具：Certbot是Let's Encrypt官方推荐的证书管理工具。

（2）申请SSL证书：运行Certbot命令，自动验证域名所有权并获取证书。

（3）配置Nginx：Certbot会自动修改Nginx配置，添加SSL证书路径和安全参数。

（4）配置自动续期：Let's Encrypt证书有效期90天，Certbot会自动配置定时任务续期证书。

表6-6 HTTPS安全配置建议
配置项              建议设置
TLS版本             仅启用TLS 1.2和TLS 1.3
加密套件            使用强加密套件，禁用弱加密
HSTS                启用HTTP严格传输安全
证书链              配置完整的证书链

（四）系统运维

系统上线运行后需要进行日常运维管理，确保系统稳定可靠运行。

1. 日志管理

系统日志是故障排查和性能分析的重要依据，需要合理配置日志收集和管理策略。

表6-7 日志类型说明
日志类型            位置                            内容说明
应用日志            /var/log/modeltrain/app.log    业务逻辑日志、错误信息
访问日志            /var/log/nginx/access.log      HTTP请求记录
错误日志            /var/log/nginx/error.log       Nginx错误信息
系统日志            /var/log/syslog                系统级事件

日志管理要点：

（1）日志级别：生产环境使用INFO级别，记录关键业务信息和错误。调试时临时启用DEBUG级别获取详细信息。

（2）日志轮转：配置logrotate工具进行日志轮转，每天生成新日志文件，保留30天历史记录，压缩旧日志节省磁盘空间。

（3）日志分析：定期分析日志，识别异常模式和性能瓶颈。可使用grep、awk等工具进行日志筛选和统计。

2. 数据备份

数据备份是保护业务数据安全的重要措施，需要制定合理的备份策略。

备份策略：

（1）备份频率：每天凌晨自动执行全量备份，业务高峰期可增加增量备份频率。

（2）备份保留：保留7天的备份文件，重要时间点的备份可长期保留。

（3）备份存储：备份文件存储在独立的存储位置，避免与主数据存储在同一磁盘。

（4）备份验证：定期验证备份文件的完整性和可恢复性。

表6-8 备份恢复流程
步骤            操作说明
1              停止后端服务
2              备份当前数据库文件（以防恢复失败）
3              解压备份文件
4              替换当前数据库文件
5              启动后端服务
6              验证数据完整性

3. 性能监控

性能监控帮助及时发现系统问题，确保系统稳定运行。

监控指标：

表6-9 性能监控指标
监控项目            正常范围                告警阈值
CPU使用率           <70%                    >90%
内存使用率          <80%                    >95%
磁盘使用率          <80%                    >90%
API响应时间         <500ms                  >2000ms
错误率              <1%                     >5%

监控方法：

（1）系统资源监控：使用top、htop命令监控CPU和内存使用情况，使用df命令监控磁盘空间。

（2）服务健康检查：后端提供/api/health健康检查接口，定期请求验证服务可用性。

（3）日志监控：监控错误日志数量，异常增加时及时告警。

（4）外部监控：可使用UptimeRobot等外部监控服务，从外部网络验证服务可用性。

4. 故障排查

常见故障及排查方法：

表6-10 常见故障排查指南
故障现象                    可能原因                            排查方法
后端服务无法启动            配置错误、端口占用                  查看服务日志、检查端口
前端页面无法访问            Nginx配置错误、服务未启动           检查Nginx状态和配置
API请求超时                 后端服务异常、网络问题              查看后端日志、测试网络
数据库错误                  数据库锁定、磁盘满                  检查数据库文件、磁盘空间
内存不足                    内存泄漏、并发过高                  重启服务、增加内存
SSL证书过期                 证书未续期                          检查证书有效期、手动续期

故障排查步骤：

（1）确认故障现象：明确故障的具体表现和影响范围。

（2）查看服务状态：使用systemctl status命令查看各服务运行状态。

（3）分析日志信息：查看应用日志和系统日志，定位错误原因。

（4）检查系统资源：确认CPU、内存、磁盘等资源是否充足。

（5）实施修复措施：根据故障原因采取相应的修复措施。

（6）验证修复结果：确认系统恢复正常运行。

5. 运维建议

为确保系统长期稳定运行，提出以下运维建议：

（1）建立监控告警机制：配置自动化监控和告警，及时发现和处理异常。

（2）定期更新维护：定期更新操作系统补丁和依赖包版本，修复安全漏洞。

（3）制定应急预案：制定故障应急处理流程，明确责任人和处理步骤。

（4）文档化运维操作：记录运维操作过程和配置变更，便于问题追溯和知识传承。

（5）容量规划：根据业务增长趋势，提前规划服务器资源扩展。

综上所述，通过合理的部署架构设计、规范的部署流程和完善的运维管理，可以确保系统在生产环境中稳定可靠运行，为企业提供高质量的大模型管理服务。
