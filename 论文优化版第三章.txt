================================================================================
三、 系统总体设计
================================================================================

（一）业务流程设计

1. 用户登录流程
用户访问系统时，首先需要完成身份认证。系统采用JWT双令牌机制，用户输入邮箱和密码后，系统验证用户身份，验证成功后颁发Access Token和Refresh Token。Access Token有效期为15分钟，用于API调用认证；Refresh Token有效期为7天，通过HttpOnly Cookie传输，用于刷新Access Token。当Access Token过期时，前端自动使用Refresh Token请求新的Access Token，实现无感刷新。

图3-1-1 用户登录流程

2. 模型配置流程
管理员登录系统后，进入模型配置管理模块。首先添加模型提供商信息，包括提供商名称、API地址、API Key等。配置完成后，系统可通过API自动同步该提供商的可用模型列表。管理员选择需要启用的模型，配置模型参数（如温度、最大Token数等），保存后该模型即可在对话测试和模型对比模块中使用。

图3-1-2 模型配置流程

3. 模型测试流程
用户在模型对话测试模块中，首先选择已配置的模型，创建新会话或选择历史会话。输入消息后，系统将请求发送至后端API，后端通过LLM客户端封装层调用对应模型提供商的API。模型返回响应后，系统解析响应内容，如果包含思维链标签<think>，则单独提取并展示推理过程。响应内容实时通过SSE流式传输至前端，前端逐字渲染并支持Markdown格式。

图3-1-3 模型测试流程

4. 模型训练流程
用户上传训练数据集（JSON格式），系统自动校验数据格式并存储至服务器。用户创建训练任务时，选择基座模型、训练数据集，配置训练参数（学习率、Epoch、Batch Size、LoRA秩等）。任务创建后，系统更新任务状态为"运行中"，并启动SwanLab监控服务。训练过程中，系统实时记录训练日志和指标数据。训练完成后，系统生成训练报告并更新任务状态。

图3-1-4 模型训练流程

（二）系统架构设计

1. 系统逻辑架构
本系统采用经典的三层架构设计，分为表示层、业务逻辑层和数据访问层，同时集成外部LLM服务和监控工具，系统逻辑架构如图3-2-1所示。
表示层采用Vue 3框架构建，包含模型配置、对话测试、模型训练、系统管理四个功能页面，通过Element Plus组件库提供统一的UI规范，使用Vuex管理全局状态，Vue Router实现路由导航，Axios封装HTTP请求。
业务逻辑层采用FastAPI框架构建RESTful API服务，核心服务包括用户认证服务（JWT双令牌机制）、模型配置服务、对话管理服务和训练任务服务。LLM客户端封装层采用策略模式，为OpenAI、DeepSeek等不同提供商提供统一调用接口。中间件层提供CORS跨域、JWT鉴权和日志记录等基础能力。
数据访问层使用SQLAlchemy ORM操作数据库，通过Alembic管理数据库迁移，支持SQLite（开发环境）和MySQL（生产环境）。外部服务层集成第三方LLM API、SwanLab训练监控、Nginx反向代理和Docker容器化部署。

图3-2-1 系统逻辑架构

2. 系统功能结构图
系统功能结构按照模块化设计原则组织，主要包括8个功能模块：

图3-2-2 系统功能结构

3. 技术架构设计
系统采用前后端分离架构，前端和后端独立部署，通过HTTP/HTTPS协议进行通信，技术总体结构如图3-2-3所示。
前端基于Vue 3框架（Composition API）构建，使用Vite作为构建工具实现快速热更新，Element Plus提供统一的UI组件库，Vuex管理全局状态，Vue Router实现路由导航，Axios封装HTTP请求与后端通信。
后端基于FastAPI框架构建RESTful API服务，使用SQLAlchemy 2.x作为ORM框架实现数据持久化，Alembic管理数据库迁移，PyJWT实现JWT身份认证，passlib（bcrypt）进行密码加密存储，httpx作为HTTP客户端调用第三方大模型API。数据库采用SQLite作为开发环境存储引擎，支持切换至MySQL、PostgreSQL等生产级数据库。训练过程通过SwanLab进行可视化监控，实时展示损失曲线、学习率变化等训练指标。

图3-2-3 技术架构

（三）系统网络拓扑设计
本系统采用B/S（Browser/Server）架构，用户通过浏览器访问系统，系统网络拓扑如图3-3-1所示。在客户端层，用户通过Chrome、Firefox、Edge等主流浏览器访问系统前端页面。Web服务层部署Nginx作为反向代理服务器，负责静态资源托管和请求转发，前端应用（Vue 3）编译后的静态文件部署在Nginx上，API请求通过Nginx转发至后端服务。应用服务层由FastAPI应用服务处理业务逻辑，通过Uvicorn ASGI服务器运行，支持多实例部署实现水平扩展和负载均衡。数据服务层由数据库服务器承担，存储用户信息、模型配置、对话记录、训练任务等业务数据。在外部服务层，系统通过HTTPS协议调用第三方大模型API（OpenAI、Anthropic、DeepSeek等），同时集成SwanLab服务提供训练可视化监控。

图3-3-1 系统网络拓扑

（四）数据库设计
本系统采用SQLAlchemy ORM框架进行数据库建模，通过定义Python模型类映射数据库表结构，实现了面向对象的数据库操作。数据库采用SQLite作为默认存储引擎，同时支持切换至MySQL、PostgreSQL等关系型数据库。系统共设计14张数据表，按照功能模块划分为用户管理、模型提供商管理、模型配置管理、模型测试、对话管理、训练管理等六个模块，各实体之间的关系如图3-5-1所示。
1.数据库E-R图
用户（User）是系统的核心实体，与其他大部分实体存在一对多的关联关系。在模型管理方面，用户可以创建多个模型配置（ModelConfig），每个配置归属于一个模型提供商（ModelProvider）；模型提供商同时管理其下属的提供商模型列表（ProviderModel），用户也可以注册多个本地部署的模型（Model）。
在对话与测试方面，用户可以创建多个对话会话（ChatSession），每个会话包含多条对话消息（ChatMessage）。用户还可以发起模型对话测试（ModelPlaygroundChat），每次测试记录关联一个模型配置，同时支持多模型对比测试（ModelTest）。系统提示词（SystemPrompt）和测试提示词模板（TestPrompt）均由用户创建和管理，为对话和测试提供可复用的提示词模板。
在训练管理方面，用户上传训练数据集（Dataset）后，创建训练配置（TrainingConfig）定义超参数，再创建训练任务（TrainingTask）将数据集、配置和基座模型关联在一起。一个数据集可被多个训练任务使用，一个配置也可被多个任务引用，从而实现灵活的组合复用。

图3-5-1 数据库E-R图

2.核心业务表清单
系统共包含14张核心业务表，按功能模块分类如表3-5-2所示。

名称	代码	所属模块	说明
用户表	users	用户管理	存储用户基本信息、角色及权限
模型提供商表	model_providers	模型提供商管理	存储模型服务提供商信息
提供商模型表	provider_models	模型提供商管理	存储各提供商支持的模型列表
模型配置表	model_configs	模型配置管理	存储模型调用配置参数
本地模型表	models	模型管理	存储本地部署的模型信息
模型测试记录表	model_tests	模型测试	存储模型对比测试记录
模型对话测试表	model_playground_chats	模型测试	存储模型对话测试消息
对话会话表	chat_sessions	对话管理	存储用户对话会话信息
对话消息表	chat_messages	对话管理	存储对话消息内容
系统提示词表	system_prompts	提示词管理	存储系统提示词模板
测试提示词模板表	test_prompts	提示词管理	存储可复用的测试问题模板
训练数据集表	datasets	训练管理	存储训练数据集信息
训练配置表	training_configs	训练管理	存储训练超参数配置
训练任务表	training_tasks	训练管理	存储训练任务状态及进度
表3-5-2 核心业务表清单

3. 用户表设计

用户表（users）是系统的核心基础表，存储用户的身份认证信息和角色权限。系统采用基于角色的访问控制模型，用户角色分为普通用户（user）和管理员（admin）两种。密码字段存储经bcrypt算法加密后的哈希值，确保用户密码安全。用户表的详细字段设计如表3-5-3所示。

名称	代码	数据类型	允许为空	说明
用户ID	id	Integer	否	主键，自增
邮箱	email	String	否	唯一索引，用于登录
昵称	nickname	String	是	用户显示昵称
密码哈希	password_hash	String	否	bcrypt加密存储
角色	role	String	否	user/admin，默认user
是否管理员	is_admin	Boolean	否	管理员标识，默认false
是否激活	is_active	Boolean	否	账号激活状态，默认true
创建时间	created_at	DateTime	否	账号创建时间戳
更新时间	updated_at	DateTime	是	最后更新时间戳
表3-5-3 用户表（users）

4. 模型提供商表设计

模型提供商表（model_providers）存储系统支持的大语言模型服务提供商信息，包括OpenAI、Anthropic、DeepSeek等。每个提供商通过唯一的字符串ID标识，记录其API接口地址和基本描述信息。提供商状态字段用于控制该提供商是否对用户可用。详细字段设计如表3-5-4所示。

名称	代码	数据类型	允许为空	说明
提供商ID	id	String(100)	否	主键，唯一标识
提供商名称	name	String(200)	否	提供商显示名称
API地址	api_url	String(500)	否	API接口基础地址
描述	description	Text	是	提供商描述信息
图标地址	icon_url	String(500)	是	提供商图标URL
状态	status	Integer	否	1启用/0禁用，默认1
创建时间	created_at	DateTime	否	创建时间戳
更新时间	updated_at	DateTime	是	更新时间戳
表3-5-4 模型提供商表（model_providers）

5. 提供商模型表设计

提供商模型表（provider_models）存储各模型提供商支持的具体模型列表。系统通过API接口自动同步各提供商的可用模型，将模型名称、大小、是否支持视觉等信息记录到该表中。主键采用提供商ID与模型ID的组合，确保同一提供商下模型的唯一性。详细字段设计如表3-5-5所示。

名称	代码	数据类型	允许为空	说明
模型ID	id	String(200)	否	主键，provider_id+model_id
提供商ID	provider_id	String(100)	否	外键，关联模型提供商表
模型标识	model_id	String(200)	否	模型在提供商中的标识
模型名称	model_name	String(200)	否	模型显示名称
模型大小	size	Integer	是	模型大小（字节）
描述	description	Text	是	模型描述信息
是否视觉模型	is_vision	Boolean	否	是否支持图像输入，默认false
状态	status	Integer	否	1可用/0不可用，默认1
创建时间	created_at	DateTime	否	创建时间戳
更新时间	updated_at	DateTime	是	更新时间戳
表3-5-5 提供商模型表（provider_models）

6. 模型配置表设计

模型配置表（model_configs）是系统的核心业务表之一，存储用户创建的模型调用配置。每条配置记录了完整的模型调用参数，包括API端点、密钥、推理参数（温度、Top P、Top K等），使用户能够灵活配置不同模型的调用行为。配置通过外键关联用户表和模型提供商表，实现多租户隔离。详细字段设计如表3-5-6所示。

名称	代码	数据类型	允许为空	说明
配置ID	id	String(100)	否	主键，UUID格式
用户ID	user_id	Integer	否	外键，关联用户表
提供商ID	provider_id	String(100)	否	外键，关联模型提供商表
提供商名称	provider_name	String(200)	否	冗余字段，提供商显示名称
API端点	endpoint	String(500)	否	API调用地址
API密钥	api_key	Text	是	加密存储的API密钥
模型ID	model_id	String(200)	否	模型唯一标识
模型名称	model_name	String(200)	否	模型显示名称
模型类型	type	String(50)	否	text/vision，默认text
温度	temperature	Float	否	生成随机性，0-2，默认0.7
最大Token数	max_tokens	Integer	否	最大生成长度，默认8192
Top P	top_p	Float	否	核采样参数，0-1，默认0.9
Top K	top_k	Float	否	Top K采样参数，默认0
状态	status	Integer	否	1启用/0禁用，默认1
创建时间	created_at	DateTime	否	创建时间戳
更新时间	updated_at	DateTime	是	更新时间戳
表3-5-6 模型配置表（model_configs）

7. 本地模型表设计

本地模型表（models）存储在服务器本地部署的大语言模型信息，支持基座模型和经LoRA微调后的模型。每条记录包含模型的存储路径、参数规模、运行状态等关键信息，方便系统管理和调度本地模型资源。详细字段设计如表3-5-7所示。

名称	代码	数据类型	允许为空	说明
模型ID	id	Integer	否	主键，自增
模型名称	name	String(255)	否	唯一约束，模型名称
显示名称	display_name	String(255)	否	模型显示名称
模型路径	model_path	String(500)	否	本地模型文件路径
模型类型	model_type	String(100)	是	base/lora/full等
状态	status	String(50)	否	active/inactive/loading/error
是否可用	is_available	Boolean	否	模型可用标识，默认true
描述	description	Text	是	模型描述信息
参数规模	parameters	String(100)	是	7B/13B等参数规模
创建人	created_by	Integer	是	外键，关联用户表
创建时间	created_at	DateTime	否	创建时间戳
更新时间	updated_at	DateTime	是	更新时间戳
表3-5-7 本地模型表（models）

8. 模型测试记录表设计

模型测试记录表（model_tests）存储用户发起的模型对比测试记录。用户可以同时选择多个模型对同一输入进行推理，系统将各模型的输出结果以JSON格式存储，便于后续的对比分析和评估。详细字段设计如表3-5-8所示。

名称	代码	数据类型	允许为空	说明
测试ID	id	Integer	否	主键，自增
用户ID	user_id	Integer	否	外键，关联用户表
测试名称	test_name	String(255)	否	测试任务名称
测试模型列表	models_tested	Text	是	JSON格式，测试模型列表
输入数据	input_data	Text	否	测试输入内容
测试结果	results	Text	是	JSON格式，各模型输出结果
是否流式	is_streaming	Boolean	否	是否使用流式响应，默认false
创建时间	created_at	DateTime	否	创建时间戳
表3-5-8 模型测试记录表（model_tests）

9. 模型对话测试表设计

模型对话测试表（model_playground_chats）存储用户在模型对话测试模块中的交互记录。每条记录对应一条对话消息，通过session_id字段将同一会话的消息关联在一起。该表同时记录模型的推理过程（thinking），支持展示思维链推理的中间步骤。详细字段设计如表3-5-9所示。

名称	代码	数据类型	允许为空	说明
记录ID	id	Integer	否	主键，自增
用户ID	user_id	Integer	是	外键，关联用户表
会话ID	session_id	String	否	会话标识，索引字段
模型配置ID	model_config_id	String(100)	是	外键，关联模型配置表
角色	role	String	否	user/assistant/error
消息内容	content	Text	否	消息文本内容
推理过程	thinking	Text	是	模型推理的思维链内容
创建时间	created_at	DateTime	否	创建时间戳
表3-5-9 模型对话测试表（model_playground_chats）

10. 对话会话表设计

对话会话表（chat_sessions）存储用户创建的对话会话信息。每个会话代表一次独立的人机对话过程，用户可以创建多个会话并在不同会话间切换。会话通过外键关联用户表，实现用户级别的数据隔离。详细字段设计如表3-5-10所示。

名称	代码	数据类型	允许为空	说明
会话ID	id	Integer	否	主键，自增
用户ID	user_id	Integer	否	外键，关联用户表
会话标题	title	String(255)	否	默认"新对话"
创建时间	created_at	DateTime	否	创建时间戳
更新时间	updated_at	DateTime	是	最后更新时间戳
表3-5-10 对话会话表（chat_sessions）

11. 对话消息表设计

对话消息表（chat_messages）存储对话会话中的每一条消息记录。消息角色分为用户消息（user）、助手回复（assistant）和系统消息（system）三种类型。通过外键关联对话会话表，支持级联删除操作。详细字段设计如表3-5-11所示。

名称	代码	数据类型	允许为空	说明
消息ID	id	Integer	否	主键，自增
会话ID	session_id	Integer	否	外键，关联对话会话表
角色	role	String(50)	否	user/assistant/system
消息内容	content	Text	否	消息文本内容
模型名称	model_name	String(255)	是	生成该消息的模型名称
是否流式	is_streaming	Boolean	否	是否为流式响应，默认false
创建时间	created_at	DateTime	否	创建时间戳
表3-5-11 对话消息表（chat_messages）

12. 系统提示词表设计

系统提示词表（system_prompts）存储系统预定义和用户自定义的提示词模板。提示词支持多种格式类型（OpenAI、Ollama、自定义），并按分类组织。系统预定义提示词通过is_system字段标识，不可被普通用户删除。详细字段设计如表3-5-12所示。

名称	代码	数据类型	允许为空	说明
提示词ID	id	Integer	否	主键，自增
名称	name	String(255)	否	提示词名称
内容	content	Text	否	提示词正文内容
描述	description	Text	是	提示词描述信息
格式类型	format_type	String(50)	否	openai/ollama/custom，默认openai
分类	category	String(100)	否	general/coding/translation等
是否默认	is_default	Boolean	否	是否为默认提示词，默认false
是否系统预定义	is_system	Boolean	否	系统预定义标识，默认false
创建人	created_by	Integer	是	外键，关联用户表
创建时间	created_at	DateTime	否	创建时间戳
更新时间	updated_at	DateTime	是	更新时间戳
表3-5-12 系统提示词表（system_prompts）

13. 测试提示词模板表设计

测试提示词模板表（test_prompts）存储可复用的测试问题模板，供模型对比测试模块快速调用。用户可以预先编辑常用的测试问题，在进行模型对比测试时直接选用，提高测试效率。详细字段设计如表3-5-13所示。

名称	代码	数据类型	允许为空	说明
模板ID	id	Integer	否	主键，自增
标题	title	String(255)	否	模板标题
内容	content	Text	否	模板正文内容
创建人	created_by	Integer	是	外键，关联用户表
创建时间	created_at	DateTime	否	创建时间戳
更新时间	updated_at	DateTime	是	更新时间戳
表3-5-13 测试提示词模板表（test_prompts）

14. 训练数据集表设计

训练数据集表（datasets）存储用户上传的模型训练数据集信息。系统支持JSON、JSONL、CSV等多种数据格式，上传时自动校验数据格式的合法性。数据集文件存储在服务器指定目录中，表中记录文件路径、大小等元数据信息。详细字段设计如表3-5-14所示。

名称	代码	数据类型	允许为空	说明
数据集ID	id	Integer	否	主键，自增
数据集名称	name	String(255)	否	数据集名称
描述	description	Text	是	数据集描述信息
文件路径	file_path	String(500)	否	服务器文件存储路径
文件大小	file_size	Integer	是	文件大小（字节）
格式类型	format_type	String(50)	是	json/jsonl/csv等
上传人	uploaded_by	Integer	是	外键，关联用户表
创建时间	created_at	DateTime	否	创建时间戳
表3-5-14 训练数据集表（datasets）

15. 训练配置表设计

训练配置表（training_configs）存储模型训练的超参数配置。配置数据以JSON格式存储，包含学习率、训练轮次、批次大小、LoRA秩等训练超参数，支持灵活的参数组合和配置复用。详细字段设计如表3-5-15所示。

名称	代码	数据类型	允许为空	说明
配置ID	id	Integer	否	主键，自增
配置名称	name	String(255)	否	配置名称
配置数据	config_data	JSON	否	JSON格式，完整训练超参数
创建人	created_by	Integer	是	外键，关联用户表
创建时间	created_at	DateTime	否	创建时间戳
更新时间	updated_at	DateTime	是	更新时间戳
表3-5-15 训练配置表（training_configs）

16. 训练任务表设计

训练任务表（training_tasks）是训练管理模块的核心表，存储每次模型训练任务的完整信息。任务状态支持pending（等待中）、running（运行中）、completed（已完成）、failed（失败）四种状态。训练过程中的日志文件和输出模型分别存储在服务器指定目录中，SwanLab监控链接用于实时查看训练指标。详细字段设计如表3-5-16所示。

名称	代码	数据类型	允许为空	说明
任务ID	id	Integer	否	主键，自增
任务名称	name	String(255)	否	训练任务名称
基座模型	model_name	String(255)	否	训练使用的基座模型名称
数据集ID	dataset_id	Integer	是	外键，关联训练数据集表
配置ID	config_id	Integer	是	外键，关联训练配置表
任务状态	status	String(50)	否	pending/running/completed/failed
训练进度	progress	Float	否	0-100，训练完成百分比
日志文件	log_file	String(500)	是	训练日志文件路径
输出目录	output_dir	String(500)	是	训练模型输出目录
SwanLab地址	swanlab_url	String(500)	是	SwanLab监控页面链接
开始时间	started_at	DateTime	是	任务开始执行时间
完成时间	completed_at	DateTime	是	任务完成时间
创建人	created_by	Integer	是	外键，关联用户表
创建时间	created_at	DateTime	否	任务创建时间戳
表3-5-16 训练任务表（training_tasks）
